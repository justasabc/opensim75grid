# ref
#--------------------------------------------------------------------------
# http://opensimulator.org/wiki/Freeswitch_Module
# http://wiki.osgrid.org/index.php/Freeswitch_HowTo2
# http://wiki.freeswitch.org/wiki/Installation_Guide#Compiling_and_Installation
# http://wiki.freeswitch.org/wiki/Linux_Quick_Install_Guide
#--------------------------------------------------------------------------

#sudo apt-get install git-core build-essential autoconf automake libtool libncurses5 libncurses5-dev make libjpeg-dev pkg-config unixodbc unixodbc-dev zlib1g-dev

apt-get install git make build-essential autoconf libtool libjpeg-dev libncurses5 unixodbc

cd /usr/local/src/
git clone git://git.freeswitch.org/freeswitch.git
cd freeswitch
./bootstrap.sh

# configuration for opensim
vim modules.conf
codecs/mod_siren
xml_int/mod_xml_curl

# make and install
./configure
make 
make install
make all install cd-sounds-install cd-moh-install
make all cd-sounds-install cd-moh-install
cd /usr/local/freeswitch/bin/
./freeswitch

# check if statred
ps -ef | grep freeswitch
#root     25771  4706  1 00:23 pts/4    00:00:00 ./freeswitch

# OK
freeswitch>help
freeswitch>shutdown

# configuration for opensim
cd /usr/local/freeswitch/conf/autoload_configs/
# activate mod_siren and mod_xml_curl in /usr/local/freeswitch/conf/autoload_configs/modules.conf.xml, since it's disabled by default on a fresh install
vim modules.conf.xml
<load module="mod_xml_curl"/>
<load module="mod_siren"/>

# configure mod_xml_curl
# mod_xml_curl is a freeswitch module which enables dynamic configuration of freeswitch from a web server. In this case, it is the opensim region server.
vim xml_curl.conf.xml
<configuration name="xml_curl.conf" description="cURL XML Gateway">
<bindings>
   <binding name="directory">
           <param name="gateway-url" value="http://192.168.1.200:8004/fsapi/freeswitch-config" bindings="directory"/>
           <param name="gateway-credentials" value="freeswitch:password"/>
           <param name="disable-100-continue" value="true"/>
   </binding>
   <binding name="dialplan">
           <param name="gateway-url" value="http://192.168.1.200:8004/fsapi/freeswitch-config" bindings="dialplan"/>
           <param name="gateway-credentials" value="freeswitch:password"/>
           <param name="disable-100-continue" value="true"/>
   </binding>
</bindings>
</configuration>


# configure vars.xml
# The /usr/local/freeswitch/conf/vars.xml requires modification to enable the siren14 codec
  <X-PRE-PROCESS cmd="set" data="global_codec_prefs=G7221@32000h,G722,PCMU,PCMA,GSM"/> 
# G7221@32000h is the siren14 codec


# configure conference.conf.xml
# By default, FreeSwitch plays hold music when there is only one avatar in the conference and beeps for everyone when avatars arrive and leave. To disable, edit /usr/local/freeswitch/conf/autoload_configs/conference.conf.xml

# comment out somethings.


#-----------------------------------------------------------------------
# Robust and OpenSim configuration
#-----------------------------------------------------------------------
# In this case, the grid service is running on 192.168.1.3 and the FreeSWITCH server is running on 192.168.1.4.
vim Robust.ini
[FreeswitchService]
   LocalServiceModule = OpenSim.Services.FreeswitchService.dll:FreeswitchService
   ServerAddress = http://192.168.1.4

vim OpenSim.ini
[FreeSwitchVoice]
   Enabled = true
   LocalServiceModule = OpenSim.Services.Connectors.dll:RemoteFreeswitchConnector
   FreeswitchServiceURL = http://192.168.1.3:8004/fsapi

# Firewall Config
# Basically open ports 1720 and 5060, and maybe 50505 must be open for listening.
